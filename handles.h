/*
        :d+-+ooooossooosyooyyyyydyyyyyyyyymyyyyyyyyyyyhNyyyyyyyyyyyyyyyydyyyyyyyyyyyyyyyyyyyyyyhyyyyyyyyyh///////+hhyyyyhdhyyyyodooooooooooooom-
       .do:-/oooso:sooohooyyyyyydyyyyyyyymyyyyyyyyyyyyNyyyyyyyyyyyyyyyyyddyyyyyyyyyyyyyyyyyyyyhmyyyyyyyyyhs////////shyyyyyhdhyyyyyoooooooooooosd
       hs/--+ooos::soohoosyyyyydyyyyyyyydhyyyyyyyyyyymhyyyyyyyyyyyyyyyyyddyyyyyyyyyyyyyyyyyyyydyhyyyyyyyhyd/////////omyyyyyyhdyyshoooooooooo+oom-
      /yo---ooooy::ooysosyyyyyhdyyyyyyyhdyyyyyyyyyyyddyyyyyyyyyyyyyyyyyhhmyyyyyyyyyyyyyyyyyyyydsdyyyyyyyhyys/////////shyyyyyyydhyyyoooooooooo:oyy
     `ho/--:/oooy/:/shooyyyyyymyyyyyyyymyyyyyyyyyyyhNyyyyyyyyyyyhyyyyyyhymyyyyyyyhyyyyyyyyyyyyhshhyyyyyydyyh/////////oddhhyyyyyhdydoooooooooo:+oN`
     +so:++o//+oso/:doosyyyyyhdyyyyyyymhyyyyyyyyyyhNhyyyyyyyyyyyhyyyyyyhydyyyyyyyhyyyyyyyyyyydsssdyyyyyydhyd+/////////+yhhdhyyyyyddsooooooooo:/oh/
     hoo/ooooo++oy+/hooyyyyyymyyyyyyyhdyyyyyyyyyyhdmyyyyyyyyyyydyyyyyyyydhyyyyyyydyyyyyyyyyyydso+dyyyyyymdyhs///////////shyhhyyyyyhhoooooo+/--/osh
    /soooooooooooy+yooyyyyyyhdyyyyyyymyyyyyyyyyyhhdhyyyyyyyyyyhdyyyyyyyydyyyyyyyydyyyyyyyyyyhyo//yhyyyyydhyyy//////////oyymhydhyyyydoooo/::/+//oom
    yoooooooooooosshooyyyyyymyyyyyyyhdyyyyyyyyyhdsmyyyyyyyyyyydyyyyyyyyymyyyyyyydyyyyyyyyyyydo///+dyyyyydhyyy////////////sdhdhhhyyydoo+//+oooo/ood-
   .yooooooooooooohyosyyyyyymyyyyyyymhyyyyyyyyydssdyyyyyyyyyymdyyyyyyyyhdyyyyyyydyyyyyyyyyyhy/////dyyyyhhhyyh/////////////+dyhhyhyydsooooooooo+ooh/
   +oooooooooooooohooyyyyyydhyyyyyyymyyyyyyyyyms+yhyyyyyyyyydmyyyyyyyyydyyyyyyyhdyyyyyyyyyyd+/////hyyyydohyyh//////////////oyyhhyyydyooooooooooooyo
   soosooooooooooohooyyyyyymyyyyyyyhdyyyyyyyydy+/hyyyyyyyyydydyyyyyyyyydyyyyyyydyyyyyyyyyyhs//////yyyyyh+hyyh//////////////+ddyydyydysooooooooooosy
   yooyooooooooooohosyyyyyymyyyyyyydhyyyyyyyhh///dyyyyyyyyhhyhyyyyyyyyhyyyhyyyydyyyyyyyyyyh///////yyyyhs/hyyy///////////////+hhyydydyyooooooooooosy
  .yooyooooosooooohosyyyyyhdyyyyyyymyyyyyyyym+///dyyyyyyyydshyyyyyyyyyyyyhyyyydhyyyyyyyyyd+///////yyyyd//yyys////////////////+mdhyddyyooooooooooosy
  :sooyoooooyooooshosyyyyydhyyyyyyymyyyyyyhmyoooomhhhhyyydssdyyyyyyyyyyyhyyyyydyyyyyyyyyhy///++ooohhhhh+/yyh+/////////////////yddhydyysooooooooooss
  /ooohooooohooooyyosyyyyydyyyyyyyymhhddddddyssssmhhhhddddssdyyyyyyyyyhmyyyyydyyyyyyyyyydosyhhyyyymhhmyyhmddo+////////////////hhhhddyysooooooooooyo
  +ooomsoooohooooyhosyyyyydyyyyyhdmNdhhyyym+/////dyyyyyydyyydyyyyyyyyhhhyyyyhhyyyyyyyyydyo+++/////hyhs//+hhhssyyyo+///////////+hyhhdyyyooooooooooy/
  +oooyyoooohooooyhosyyyyydyhhddhhdmyyyyyhy//////hyyyyyhyo/ohyyyyyyyhhhyyyyydyyyyyyyyyhs//////////dyh////hh+////+ossoo+////////yyydhyyyooooooooooh-
  +ooy-yooooyyoooydosyyyyydhyyyyyyhhyyyyym+//////yyyyyyd+//shyyyyyyhhshyyyymhyhyyyyyyhh//////////+dh+///+dy//////////+++///////yyyhhyyysoooooooood`
  /ooy sooooydoooydooyyyyydyyyyyyhsshyyyhh///////odyyyyy///yhyyyyyhdshyyyyddyhdyyyyyyd///////////shs////od/////////////////////shyhhyyysooooooosod
  :sos /ooooyNsooyhyoyyyyydyyyyyyd++dyyydo//////++mhhhdso++yhyyyyydsohyyyhdyhhhyyyyyd+/////++osssdhoo+//yo/////////////////////dhyydyyysooooosoyoy
  .yoo `yoooydhooyydosyyyydyyyyyyd//dyyym/////+///hyyyd+oysyhyyyydo/hyyyhhhyhyhyyyydo/////oyyo+++d+/////o/////////////////////odhhhdhhyyooooosoyy/
   hoo  oooosdhsoyydsoyyyydhyyyyhy//sdhdNdddddmhsosdyyh+//ohhyyydo/ohyyhshhyshyyyyds/////+o+++++ssooyssssooss/////////////////dys/:::/oyoooossoyd.
   sos  .yoosh+hosyyhoyyyyddyyyydo/+ommNMNmmdddmmmNMmdy+ss+sdyydo//hyyhsshy+sdyyyds///////sysymmNmmmmmmmNNMMNNdso+///////////so-....-..-osooyoysd
   /sy   yoooysyyoyydsoyyydmyyyym//+yNNmy+///:://++sNNNds++odyhs//yyyho+hs/+yhyyhs///////+ohNmhso+++///++osydNMmy++//////////h:.-/ooss+..sooyoyss
   `hh` `oyoosdshsyyydosyydhhyyym/yNMhhho:::/shmmmdhdmsdNms+mhh//ohhy++hs//+dyyds/////////hho/:/oyhhhyo/::::/ohNMmo/////////yo+oo++/+o/..:yohoyh:
    sy: ::/soohs+ysyyhhoyyhodyyymmMNs//hs::omNNNNNNNNM+:+hNsdd//+hhs//yo///sdyds/////////s+:::omNNNNNNNmo:::::/odMMy///////+dy+////////...hohyom`
    .hs :-.osoyh+ohyyydysyhsyhydMMNs/::/+:oNNNNNNNNmmNd:::odh+//hy+//++////dyds///////////:::sNNNNNNNddNN+::::::/yMMh//////yoo//+oo:-::...hohysy
     od`.+.-sooyhsyhyyydsshy+dhMMMy/::::::NNNNNMMMd/+NN+:::/y//+o/////////oddo///////////:::+NNNNNMMh//NNd:::::::/hMMy////oh/++ossys.....-yodsh/
     `h/ o..-yoshysshhyydsyh/oNNMMo::::::+MNNNMMMMNdmNNs:::://////////////dh+////////////:::hNNNMMMMNydNNN::::::::+MMN+///hyyssssssh-....ooodod`
      -h -+..-ysydsssdhyhmsd//hdMMs::::::+MmdmMMMMMMNmNy::://////////////yy//////////////:::dmdNMMMMMMNmNM/:::::::sMMh+//syssdsssssh-...:yoohod
       /: //..-syyhssyhhydyd///hmmd::::::/NmhhdmNMMMmdNs::://///////////+o///////////////:::hNhhdNMMMMNdmN:::::::/mNh///+dyyyysssssy...:hooodso
        -  :/-.-oyhhsssyhhhs+://+syo::::::ss/:://mNdhmN/:::///////////////////////////////::+s/::/yMNNddmd::::::/hyo////hhyssssssso-../yyooohh:
            ./+:./yhdssssymy:.:////+/:::::::///+ohhhmNy:::////////////////////////////////::::///+sddhhmN+:::::/o+//:.:ohsssssss+:..:syyyooohm`
              hoo/:+hh+o+oyhs..://////::::::+hdmmdmmdo::///////////////////////////////////:::+dmmdddmmd+:::::////:-..:hsyssso/-.-/syyyyysoohm
             `hoooso+os::/+oso..:////////:::::+osso+/:///////////////////////////////////////::/oyhhhyo/::://////:....yhs+//-.-/oyyyyyhyysooyd
             -yoooosds//--//+y:..///////////+soo++////////////////////////////////////////////////++++o/////////:..../h+//:-:oyhyyyyyyhhysoosy
             oooooosdyyo:-:///s-.-///////////++o++/////////////////////://////////////////////////++o++////////:....-s/////shhyyyyyyyyydyyooos
             yoosooydyyyys++//+s..-///////////////////////////////////:.///////////////////////////////////////-....y///+syyhyyyyyyyyyydyyoooh
            -yooyooyhyyyyyyyyyyh+..://///////////////////////////////:.-/+////////////////////////////////////-....ohyyyhyyyhhyyyyyyyyyddyoood
            soooyooyhhyyyyyyyyyyh:..:////////////////////////////////:.-+y///////////////////////////////////-..../hyhyyyyyydhyyyyyyyyyhNysood`
           .yoooyoosydyyyyyyyyyyyy-..:////////////////////////////////::/s//////////////////////////////////-....:hyyhyyyyyyhdyyyyyhyyyhNhsooy:
           soooyyoosydyyyyyyyyyyyys...:////////////////////////////////////////////////////////////////////:....-yyhyhyyyyyhhdyyyyydyyyyymyooss
          :yoossyoosyhyyyyyyyyyyyyho...://////////////////////////////////////////////////////////////////:....-yyyhhdyyyyyhhdyyyyhhyyyysyhoooh
         `yooso.yoooyyhyyyyyyyyyyysoo...:////////////////////////////////////////////////////////////////:....-oyyyydhhyyyyhdhyyyydyyyyyy.msood.
         sooso  hoooyyhyyyyyyyyo/:-:y+-..://////////////////////////////////////////////////////////////:....-oo-:+sdhdyyyyhdhyyyymyyyyyh shooy+
        +sos+   hooosyyyyyys+:-----+o:+-..-////////////////////////////////////////////////////////////-....:+:y-----/syyyyhmhyyyhdyyyyym `dsooh
       /yos/    yooooyyyo/:-------+o+--+/-.-:////////////////////////////////////////////////////////:-...-+/--y:-------/oyhmhyyydhyyyyym. :dood-
      :yos:     ooooo+/----------++o+---:+:-.-:////////////////////////////////////////////////////:-...-//:---y+----------/yhyyymyyyyyyd:  ohoss
     :yoo.    `.+o/:------------:+++o-----:+/-.-://///////////////////////////////////////////////-...-//:-----s+/----------shyyymyyyyyyho   hsom`
    /ys/  `.::/:----------------++++s-------:/+:--://///////////////////o+++///////////////////:-..-://--------y++:---------odyyys/+yyyyyh   `dsyo
  `oy+.`.//:--------------:///++++++y----------//+:--://///////////////////+/////////////////:-.--//:---------:y+++//:-----:+dyyh+---/dyym`   -dsm`
 .yo.`:+:---/---------:/++++++++++++s/------------////::///////////////////////////////////:--:///------------so+++++++/:--:+dyyh/----+++h/    :dhs
-/. -o:----:/-----:/+++++++++++++++++s---------------:/s+///////////////////////////////::-/o+:--------------:y+++++++++++//+hyyd/-----s--+/`   :mm.
   /+------+---:/++++++++++++++++++++y:----------------:so++oo+///////////////////////://+s+:----------------oo++++++++++++++ohyd/-----/+--:+.   /Ny
  :+-------o:/+++++++++++++++++++++++oo------------------+o//+osso+///////////////+o+++++/------------------:y++++++++++++++++hyh/------s----o-   :N:
  y-------/s++++++++++++++++++++++++++h-------------------:++///+osssoo/////+oosoo+//++/--------------------so++++++++++++++++shhy:-----o:----o.   :h`
 :+-----:+so++++++++++++++++++++++++++so--------------------:++////++ossssssso+///+o+:---------------------/y++++++++++++++++++yhd++:---/+-----s    -/
 o:----/++y++++++++++++++++++++++++++++h:---------------------:+o//////////////+o+/-----------------------:y++++++++++++++++++++hNs+++:--s-----/:    `
 s----:+++y++++++++++++++++++++++++++++os-----------------------:++oo///////+o+/--------------------------so+++++++++++++++++++++dd++++/-y------+
 m----++++y+++++++++++++++++++++++++++++h:-----------------------:////+++ss+::oo+:-----------------------+y+++++++++++++++++++++++ys++++/s------o
.m----++++y+++++++++++++++++++++++++++++oy----------------------oyso/:----s---:+sy/---------------------/y+++++++++++++++++++++++++s++++oy------o.
:s/--:++++yo+++++++++++++++++++++++++++++s+-------------------:ss+:--:+/:-s------:o/-------------------:y++++++++++++++++++++++++++s++++sy/-----+-
+:o--/++++os++++o+++++++++++++++++++++++++y:-----------------+s/-----:+-+:s--------//-----------------:y+++++++++++++++++++++++++++s++++ys+-----+-
+-o--/+++++y++++s++++++++++++++++++++++++++y---------------/o:--------://-s---------/+---------------:y++++++++++++++++++++++++++++y++++hss-----h`
o-:o-++++++h++++s++++++++++++++++++++++++++os------------/+s:-------------s----------:o-------------:y+++++++++++++++++++++++++++++y+++ohss:---/h
o--+:++++++yo++ss+++++++++++++++++++++++++++s+--------:oo/--+:-----------:o-----------:y:----------:y++++++++++++++++++++++++++++++y+++ysss:--:/s
+:--s+++++++h++y+++++++++++++++++++++++++++++s+-----+oshs----//----------s:-----------+dy/--------/y+++++++++++++++++++++++++++++++y+++hsss:-:+-o
//--:h++++++ho+h++++++++++++++++++++++++++++++ys/+os+++oh/----:+:--------y-----------+hy+s+------:y+++++++++++++++++++++++++++++++oy++sysss-:+--o
-o---oh++++++h+h+++++++++++++++++++++++++++++++hho++++++oh/-----+/-------h:---------ohy+++oo----:y++++++++++++++++++++++++++++++++ss++hssso:+---+
everthing is in a .h?
*/

Ship *ship;

bool winRender;
int winRenderW;

short resetTime = 0;
short face = 0;
void damageFace(){
	resetTime = 15;
	face = 1;
}

void happyFace(){
	resetTime = 15;
	face = 2;
}

XColor col(const char* s){
	XColor c;
	XParseColor(game.dsp, game.cmap, s, &c);
	XAllocColor(game.dsp, game.cmap, &c);
	return c;
}

vector<particle> activeParts;
vector<particle> bufferParts;
vector<laser> activeLaser;
vector<laser> buffer;

void handleParticles(){
	if(activeParts.size() > 0){
		bufferParts.clear();
		for(int i=0; i<activeParts.size(); i++){
			activeParts[i].life--;
			if(activeParts[i].life >= 0){
				if(activeParts[i].grav){
					activeParts[i].vy += gravity;
				}

				activeParts[i].vy *= drag;
				activeParts[i].vx *= drag;

				if((activeParts[i].x + activeParts[i].vx) > play.tpt[0].x && (activeParts[i].x + activeParts[i].vx) < play.tpt[terrainLen-1].x){
					int seg = (activeParts[i].x + activeParts[i].vx)/9;//twidth
					float y1 = play.tpt[seg].y;
					float y2 = play.tpt[seg+1].y;
					float xd = (activeParts[i].x + activeParts[i].vx) - play.tpt[seg].x;
					float gLevel = y1 + ((xd/9)*(y2-y1));
					if(activeParts[i].collide && ((activeParts[i].y + activeParts[i].vy) >= gLevel)){
						activeParts[i].vx = (-activeParts[i].vx)*damp;
						activeParts[i].vy = (-activeParts[i].vy)*damp;
					}else{
						activeParts[i].x += activeParts[i].vx;
						activeParts[i].y += activeParts[i].vy;
					}
				}

				bufferParts.push_back(activeParts[i]);
			}
		}
		activeParts.swap(bufferParts);
	}
}

void handleRenderParticles(float dcx, float dcy){
	for(int i=0; i<activeParts.size(); i++){
		if(activeParts[i].life > 0){
			XSetForeground(game.dsp, game.gc, activeParts[i].color[(activeParts[i].cLen * activeParts[i].life)/activeParts[i].lifeMax]);
		}else{
			XSetForeground(game.dsp, game.gc, game.col.black);
		}
		XDrawPoint(game.dsp, Buffy, game.gc, activeParts[i].x + dcx, activeParts[i].y + dcy);
	}
}

void addParticle(float x, float y, float vx, float vy, int life, bool grav, ulong color[], bool coll = true){
	particle part;
	part.x = x;
	part.y = y;
	part.vx = vx;
	part.vy = vy;
	part.lifeMax = life;
	part.life = life+1;
	part.color = color;
	part.cLen = g_yellow;
	part.grav = grav;
	part.collide = coll;
	activeParts.push_back(part);
}

void collisionParticles(float x, float y, float vx, float vy, int life, bool grav, ulong color[]){
	int gen = (int)((vx*vx) + (vy*vy))*2;
	for(int i=0; i<gen; i++){
		if((vx*vx)<9){
			if(vx > 0){
				vx = 3;
			}else{
				vx = -3;
			}
		}

		if((vy*vy)<9){
			if(vy > 0){
				vy = 3;
			}else{
				vy = -3;
			}
		}

		addParticle(x, y, randFlt(-0.5,0.3)*vx, randFlt(-0.5,0.3)*vy, life, grav, color);
	}
}

void handleLasers(){
	if(activeLaser.size() > 0){
		buffer.clear();
		for(int i=0; i<activeLaser.size(); i++){
			if((activeLaser[i].x + activeLaser[i].vx) > play.tpt[0].x && (activeLaser[i].x + activeLaser[i].vx) < play.tpt[terrainLen-1].x){
				int seg = (activeLaser[i].x + activeLaser[i].vx)/9;//twidth
				float y1 = play.tpt[seg].y;
				float y2 = play.tpt[seg+1].y;
				float xd = (activeLaser[i].x + activeLaser[i].vx) - play.tpt[seg].x;
				float gLevel = y1 + ((xd/9)*(y2-y1));

				activeLaser[i].x += activeLaser[i].vx;
				activeLaser[i].y += activeLaser[i].vy;

				//laser particles
				if(random(0,1)){
					addParticle(activeLaser[i].x, activeLaser[i].y, randFlt(0.1,0.2)*activeLaser[i].vx, randFlt(0.1,0.2)*activeLaser[i].vy, 30, true, game.col.gradLaser, false);
				}

				if((activeLaser[i].y) >= gLevel){
					activeLaser[i].active = false;

					//terrain destruct
					if(play.tpt[seg].y < maxTerrainDepth && !random(0,3) && !isPad(seg)){
						play.tpt[seg].y+= 1;
					}

					if(play.tpt[seg+1].y < maxTerrainDepth && !random(0,3) && !isPad(seg+1)){
						play.tpt[seg+1].y+= 1;
					}

					for(int j=0; j<warps.size(); j++){
						if(warps[j].pos == seg || warps[j].pos == (seg + 1)){
							warps[j].hp--;
						}
					}

					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradLaser, false);
					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradLaser, false);
					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradLaser, false);
					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradLaser, false);
					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradPulse, false);
					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradPulse, false);
					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradYellow, false);
					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradYellow, false);
					addParticle(activeLaser[i].x, activeLaser[i].y, -randFlt(0.2,0.4)*activeLaser[i].vx, -randFlt(0.2,0.4)*activeLaser[i].vy, 60, true, game.col.gradYellow, false);
				}else if(activeLaser[i].y > altLim){
					buffer.push_back(activeLaser[i]);
				}
			}
		}
		activeLaser.swap(buffer);
	}
}

void addLaser(float x, float y, float vx, float vy){
	laser las;
	las.x = x;
	las.y = y;
	las.vx = vx;
	las.vy = vy;
	activeLaser.push_back(las);
}

void drawLaser(float dcx, float dcy){
	XSetForeground(game.dsp, game.gc, game.col.laser);
	for(int i=0; i<activeLaser.size(); i++){
		XDrawLine(game.dsp, Buffy, game.gc, activeLaser[i].x-activeLaser[i].vx+dcx, activeLaser[i].y-activeLaser[i].vy+dcy, activeLaser[i].x+dcx, activeLaser[i].y+dcy);
	}
}

short fireWait = fireDelay;

void handleFire(float dcx, float dcy){
	if(mouseDown && (fireWait == 0) && !ship->dead && ship->P){
		fireWait = fireDelay;
		float angle = atan2(mouseX-dcx-ship->x, mouseY-dcy-ship->y)-(PI/2);
		float vx = cos(angle)*laserSpeed*randFlt(1-laserSpray, 1+laserSpray);
		float vy = -sin(angle)*laserSpeed*randFlt(1-laserSpray, 1+laserSpray);
		addLaser(ship->x+vx+random(-laserRad, laserRad), ship->y+vy+random(-laserRad, laserRad), vx, vy);
		ship->P-=2;
	}else if(fireWait > 0){
		fireWait--;
	}
}

//should rememver to streamline change colors
void handleRenderStars(){
	XSetForeground(game.dsp, game.gc, game.col.star);
	for(int i=0; i<starCount; i++){
		if(play.stars[i].type == 0){
			XDrawPoint(game.dsp, Buffy, game.gc, play.stars[i].x, play.stars[i].y);
		}else{
			XDrawLine(game.dsp, Buffy, game.gc, play.stars[i].x-1, play.stars[i].y, play.stars[i].x+1, play.stars[i].y);
			XDrawLine(game.dsp, Buffy, game.gc, play.stars[i].x, play.stars[i].y-1, play.stars[i].x, play.stars[i].y+1);
		}
	}
}

void physics(){
	ship->vy += gravity;

	if(!ship->dead && ship->P > 60){
		if(k.up && ship->P){
			ship->vy -= accel;
			addParticle(ship->x, ship->y, ship->vx + randFlt(-pulseSpread,pulseSpread), ship->vy + randFlt(0.4,0.8)*pulse, 120, true, game.col.gradPulse);
			addParticle(ship->x, ship->y, ship->vx + randFlt(-pulseSpread,pulseSpread), ship->vy + randFlt(0.4,0.8)*pulse, 120, true, game.col.gradPulse);
			addParticle(ship->x, ship->y, ship->vx + randFlt(-pulseSpread,pulseSpread), ship->vy + randFlt(0.4,0.8)*pulse, 120, true, game.col.gradPulse);
			ship->P--;
		}
		if(k.down && ship->P){
			ship->vy += accel;
			addParticle(ship->x, ship->y, ship->vx + randFlt(-pulseSpread,pulseSpread), ship->vy + randFlt(0.4,0.8)*-pulse, 120, true, game.col.gradPulse);
			addParticle(ship->x, ship->y, ship->vx + randFlt(-pulseSpread,pulseSpread), ship->vy + randFlt(0.4,0.8)*-pulse, 120, true, game.col.gradPulse);
			addParticle(ship->x, ship->y, ship->vx + randFlt(-pulseSpread,pulseSpread), ship->vy + randFlt(0.4,0.8)*-pulse, 120, true, game.col.gradPulse);
			ship->P--;
		}
		if(k.left && ship->P){
			ship->vx -= accel;
			addParticle(ship->x, ship->y, ship->vx + randFlt(0.4,0.8)*pulse, ship->vy + randFlt(-pulseSpread,pulseSpread), 120, true, game.col.gradPulse);
			addParticle(ship->x, ship->y, ship->vx + randFlt(0.4,0.8)*pulse, ship->vy + randFlt(-pulseSpread,pulseSpread), 120, true, game.col.gradPulse);
			addParticle(ship->x, ship->y, ship->vx + randFlt(0.4,0.8)*pulse, ship->vy + randFlt(-pulseSpread,pulseSpread), 120, true, game.col.gradPulse);
			ship->P--;
		}
		if(k.right && ship->P){
			ship->vx += accel;
			addParticle(ship->x, ship->y, ship->vx + randFlt(0.4,0.8)*-pulse, ship->vy + randFlt(-pulseSpread,pulseSpread), 120, true, game.col.gradPulse);
			addParticle(ship->x, ship->y, ship->vx + randFlt(0.4,0.8)*-pulse, ship->vy + randFlt(-pulseSpread,pulseSpread), 120, true, game.col.gradPulse);
			addParticle(ship->x, ship->y, ship->vx + randFlt(0.4,0.8)*-pulse, ship->vy + randFlt(-pulseSpread,pulseSpread), 120, true, game.col.gradPulse);
			ship->P--;
		}
	}

	ship->vx *= drag;
	ship->vy *= drag;

	if(ship->hitXY(play.tpt,terrainLen,9)){
		if(inLanding(ship->x) && sqrt((ship->vx * ship->vx)+(ship->vy * ship->vy)) < 1.8){
			play.win = true;
			play.score += 1000;
			winRender = false;
			winRenderW = 0;
		}else if(play.hardcore){
			//if you didn't land, you died
			ship->kill();
		}else{
			ship->vy = -(ship->vy)*damp;
			ship->vx = -(ship->vx)*damp;
			float dmg = sqrt((ship->vx * ship->vx)+(ship->vy * ship->vy));
			if(dmg > 1){
				damageFace();
				ship->H -= 100*dmg;
				if(ship->H < 0){
					ship->kill();
				}
				collisionParticles(ship->x, ship->y, ship->vx, ship->vy, random(colSparkLife-colSparkLifeVar, colSparkLife+colSparkLifeVar), true, game.col.gradYellow);
			}
		}
	}else if((ship->y+ship->vy > altLim)&&(ship->x+ship->vx > xMin)&&(ship->x+ship->vx < xMax)){
		ship->move();
	}else{
		ship->vx*=-damp;
		ship->vy*=-damp;
	}

	handleLasers();
	handleParticles();
}

void drawWarp(float x, float y){
	XSetForeground(game.dsp, game.gc, game.col.red);
	XDrawLine(game.dsp, Buffy, game.gc, x, y, x + random(-10,10), y + random(-10,10));
	XDrawLine(game.dsp, Buffy, game.gc, x, y, x + random(-10,10), y + random(-10,10));
	XDrawLine(game.dsp, Buffy, game.gc, x, y, x + random(-10,10), y + random(-10,10));
	XDrawLine(game.dsp, Buffy, game.gc, x, y, x + random(-10,10), y + random(-10,10));
	XDrawLine(game.dsp, Buffy, game.gc, x, y, x + random(-10,10), y + random(-10,10));
	drawCirc(game, x, y, random(5,7), game.col.red, game.col.red);
	drawCirc(game, x, y, random(3,5), game.col.black, game.col.black);
}

void explode(float xt, float yt, float dcx, float dcy){
	float x = xt - dcx;
	float y = yt - dcy;
	for(int i=0; i<15; i++){
		int vx = randFlt(-10,10);
		int vy = randFlt(-10,10);
		for(int j=0; j<11; j++){
			addParticle(x, y+randFlt(1,2) ,vx+randFlt(-2,2), vy+randFlt(-2,2), random(300,360), true, game.col.gradYellow);
			addParticle(x, y+randFlt(1,2) ,vx+randFlt(-2,2), vy+randFlt(-2,2), random(300,360), true, game.col.gradLaserRed);
		}
	}

	for(int i=0; i<69; i++){
		addParticle(x, y+randFlt(1,2) ,randFlt(-5,5), randFlt(-5,5), random(360,420), true, game.col.gradYellow);
	}
}

void explodA(float x, float y){
	for(int i=0; i<10; i++){
		int vx = randFlt(-7,7);
		int vy = randFlt(-7,7);
		for(int j=0; j<4; j++){
			addParticle(x, y+randFlt(1,2) ,vx+randFlt(-2,2), vy+randFlt(-2,2), random(60,120), true, game.col.gradYellow);
			addParticle(x, y+randFlt(1,2) ,vx+randFlt(-2,2), vy+randFlt(-2,2), random(60,120), true, game.col.gradLaserRed);
		}
	}

	for(int i=0; i<30; i++){
		addParticle(x, y+randFlt(1,2) ,randFlt(-5,5), randFlt(-5,5), random(60,120), true, game.col.gradYellow);
	}
}

//void addLaser(float x, float y, float vx, float vy){
void exploDesu(){
	float x = ship->x;
	float y = ship->y;
	for(int i=0; i<169; i++){
		int vx = randFlt(-16,16);
		int vy = randFlt(-16,16);
		addParticle(x, y+randFlt(1,2) ,vx+randFlt(-shipBombSpread,shipBombSpread), vy+randFlt(-shipBombSpread,shipBombSpread), random(240,260), true, game.col.gradYellow);
		addParticle(x, y+randFlt(1,2) ,vx+randFlt(-shipBombSpread,shipBombSpread), vy+randFlt(-shipBombSpread,shipBombSpread), random(240,260), true, game.col.gradYellow);
		addParticle(x, y+randFlt(1,2) ,vx+randFlt(-shipBombSpread,shipBombSpread), vy+randFlt(-shipBombSpread,shipBombSpread), random(240,260), true, game.col.gradPulse);
		addParticle(x, y+randFlt(1,2) ,vx+randFlt(-shipBombSpread,shipBombSpread), vy+randFlt(-shipBombSpread,shipBombSpread), random(240,260), true, game.col.gradPulse);
		addParticle(x, y+randFlt(1,2) ,vx+randFlt(-shipBombSpread,shipBombSpread), vy+randFlt(-shipBombSpread,shipBombSpread), random(240,260), true, game.col.gradPulse);
		addParticle(x, y+randFlt(1,2) ,vx+randFlt(-shipBombSpread,shipBombSpread), vy+randFlt(-shipBombSpread,shipBombSpread), random(240,260), true, game.col.gradLaser);
		addParticle(x, y+randFlt(1,2) ,vx+randFlt(-shipBombSpread,shipBombSpread), vy+randFlt(-shipBombSpread,shipBombSpread), random(240,260), true, game.col.gradLaser);
	}

	for(int i=0; i<169; i++){
		addParticle(x, y+randFlt(1,2) ,randFlt(-5,5), randFlt(-5,5), random(360,420), true, game.col.gradYellow);
	}

	for(int i=0; i<666; i++){
		float vl = randFlt(5,15);
		float al = randFlt(0,2*PI);
		addLaser(x,y, cos(al)*vl, sin(al)*vl);
	}
}

short aSpawn = 60;
void addAlien(){
	if(aliens.size() < alienCount && aSpawn == 0 && warps.size()>0 && !play.keikaku_doori){
		alien a;
		short i = random(0, warps.size()-1);
		a.x = play.tpt[warps[i].pos].x;
		a.y = play.tpt[warps[i].pos].y;
		a.vx = random(-25,25);
		a.vy = random(-25,25);
		a.rad = 5;
		a.hp = 25;
		aSpawn = 60;
		aliens.push_back(a);
	}else if(aSpawn > 0){
		aSpawn--;
	}
}

void hitByLas(alien &a){
	float dist;
	for(int i=0; i<activeLaser.size(); i++){
		dist = sqrt((activeLaser[i].x - a.x)*(activeLaser[i].x - a.x)+(activeLaser[i].y - a.y)*(activeLaser[i].y - a.y));
		if(dist < (5*a.rad)){
			a.hp--;
			activeLaser[i].active = false;
			if(a.hp <= 0){
				break;
			}
		}
	}
}

void handleAliens(float dcx, float dcy){
	addAlien();
	for(short i=0; i<aliens.size(); i++){
		float xdiff = (ship->x - aliens[i].x);
		float ydiff = (ship->y - aliens[i].y);

		aliens[i].vx += xdiff/40;
		aliens[i].vy += ydiff/40;
		aliens[i].vx *= alienDamp;
		aliens[i].vy *= alienDamp;
		float vs = sqrt((aliens[i].vx*aliens[i].vx)+(aliens[i].vy*aliens[i].vy));
		if(vs > alienMV){
			aliens[i].vy /= vs/alienMV;
			aliens[i].vx /= vs/alienMV;
		}
		aliens[i].x += aliens[i].vx;
		aliens[i].y += aliens[i].vy;

		hitByLas(aliens[i]);
		float dist = sqrt((xdiff*xdiff)+(ydiff*ydiff));
		if(dist < aliens[i].rad && aliens[i].hp > 0){
			explodA(aliens[i].x, aliens[i].y);
			damageFace();
			ship->H -= random(100,150);
			if(!play.malphite){
				ship->vx += aliens[i].vx;
				ship->vy += aliens[i].vy;
			}
			if(ship->H < 0){
				ship->kill();
			}
			aliens.erase(aliens.begin()+i);
		}else if(aliens[i].hp <= 0){
			explodA(aliens[i].x, aliens[i].y);
			aliens.erase(aliens.begin()+i);
			play.score += 50;
		}else{
			drawCirc(game, aliens[i].x+dcx, aliens[i].y+dcy, randFlt(aliens[i].rad-1, aliens[i].rad+1), game.col.black, game.col.red);
		}
	}
}

void renderPads(float dcx, float dcy){
	XSetForeground(game.dsp, game.gc, game.col.dblue);
	for(int i=0; i<padCount; i++){
		XDrawLine(game.dsp, Buffy, game.gc, play.tpt[play.pad[i].l].x + dcx, play.tpt[play.pad[i].l].y + dcy, play.tpt[play.pad[i].r].x + dcx, play.tpt[play.pad[i].r].y + dcy);
	}
}

float sccX = shipInitX;
float sccY = 0;

float sccVX = 0;
float sccVY = 0;

void camera(){

	sccVX += (ship->x - sccX)/50;
	sccVY += (ship->y - sccY)/50;

	sccVX *= cameraDamp;
	sccVY *= cameraDamp;

	sccX += sccVX;
	sccY += sccVY;

	float dcx = game.scrW/2 - sccX;
	float dcy = game.scrH/2 - sccY;

	float minY = -9001;
	float bkminY = -9001;

	XPoint drtr[terrainLen+2];
	XPoint bkdrtr[bkTerrainLen+2];

	for(int i=1; i<(terrainLen-1); i++){
		drtr[i].x = play.tpt[i].x + dcx;
		drtr[i].y = play.tpt[i].y + dcy;

		if(drtr[i].y > minY){
			minY = drtr[i].y;
		}
	}

	for(int i=1; i<(bkTerrainLen-1); i++){
		bkdrtr[i].x = play.bktpt[i].x + dcx/2 + (game.scrW/4);
		bkdrtr[i].y = play.bktpt[i].y + dcy/2;

		if(bkdrtr[i].y > bkminY){
			bkminY = bkdrtr[i].y;
		}
	}

	drtr[0].x = drtr[1].x;
	drtr[0].y = minY + (game.scrH/2);
	drtr[terrainLen-1].x = drtr[terrainLen-2].x;
	drtr[terrainLen-1].y = minY + (game.scrH/2);

	bkdrtr[0].x = bkdrtr[1].x;
	bkdrtr[0].y = bkminY + (game.scrH/2);
	bkdrtr[bkTerrainLen-1].x = bkdrtr[bkTerrainLen-2].x;
	bkdrtr[bkTerrainLen-1].y = bkminY + (game.scrH/2);

	handleFire(dcx, dcy);

	drawPoly(game, bkdrtr, bkTerrainLen, game.col.gray24, game.col.gray24);

	drawLaser(dcx,dcy);
	ship->drawPos(game, ship->x + dcx, ship->y + dcy);
	handleRenderParticles(dcx,dcy);

	drawPoly(game, drtr, terrainLen, game.col.gray16, game.col.gray16);
	renderPads(dcx,dcy);

	for(int i=0; i<warps.size(); i++){
		drawWarp(drtr[warps[i].pos].x, drtr[warps[i].pos].y);
		if(warps[i].hp <= 0){
			explode(drtr[warps[i].pos].x, drtr[warps[i].pos].y, dcx, dcy);
			warps.erase(warps.begin()+i);
			play.score += 500;
		}
	}

	handleAliens(dcx, dcy);

	if(ship->dead && !ship->exploded){
		ship->exploded = true;
		exploDesu();
	}

	if(warps.empty()){
		play.missionDone = true;
	}else{
		play.missionDone = false;
	}
}

void handleGameMessages(){
	if((ship->y < altLim+boundWarn)||(ship->x < xMin+boundWarn)||(ship->x > xMax-boundWarn)){
		drawText(game, gms.boundary);
	}

	if(game.scrW < defW || game.scrH < defH){
		drawText(game, gms.small);
	}

	if(play.hardcore){
		drawText(game, gms.hardcore);
	}

	if(play.homunculus){
		drawText(game, gms.immortal);
	}

	if(play.malphite){
		drawText(game, gms.stable);
	}

	if(play.over9000){
		drawText(game, gms.plevel);
	}

	if(play.keikaku_doori){
		drawText(game, gms.sakujo);
	}

	stringstream ss;
	ss << warps.size();
	string txt = "Alien warp-gates remaining: " + ss.str();
	gms.alien.text = (char*)(txt.c_str());
	drawText(game, gms.alien);
}

void renderFScore(){
	stringstream ss;
	ss << "FINAL SCORE: " << play.score;
	gms.final.text = (char*)(ss.str().c_str());
	drawText(game, gms.final);
}

void renderWinner(){
	XSetForeground(game.dsp, game.gc, game.col.black);
	XFillRectangle(game.dsp, Buffy, game.gc, (game.scrW/2)-(winRenderW/2), (game.scrH/2)-(winRenderW/2), winRenderW, winRenderW);
	if(winRenderW <= game.scrW || winRenderW <= game.scrH){
		winRenderW += 10;
	}else{
		XSetForeground(game.dsp, game.gc, game.col.white);
		XCopyPlane(game.dsp, winSC, Buffy, game.gc, 0, 0, sw, sh, (game.scrW-sw)/2, (game.scrH-sh)/2, 1);
		gms.final.xr = 0.35;
		gms.winner.xr = 0.35;
	}
	drawText(game, gms.winner);
	renderFScore();
}

void renderScore(){
	stringstream ss;
	ss << "SCORE: " << play.score;
	gms.score.text = (char*)(ss.str().c_str());
	drawText(game, gms.score);
}

short deathCD = 150;
void deathTimer(){
	if(deathCD > 0 && ship->dead){
		deathCD--;
	}else if(deathCD <= 0){
		game.screen = 3;
	}
}

void handleGameRender(short screen){

	if(play.win){
		renderWinner();
	}else if(paused){
		XSetForeground(game.dsp, game.gc, game.col.black);
		XFillRectangle(game.dsp, Buffy, game.gc, 0, 0, game.scrW, game.scrH);
		drawText(game, gms.pause);
	}else if(screen == 1){
		XSetForeground(game.dsp, game.gc, game.col.black);
		XFillRectangle(game.dsp, Buffy, game.gc, 0, 0, game.scrW, game.scrH);
		XSetForeground(game.dsp, game.gc, game.col.white);
		XCopyPlane(game.dsp, startSC, Buffy, game.gc, 0, 0, sw, sh, (game.scrW-sw)/2, (game.scrH-sh)/2, 1);
	}else if(screen == 3){
		XSetForeground(game.dsp, game.gc, game.col.black);
		XFillRectangle(game.dsp, Buffy, game.gc, 0, 0, game.scrW, game.scrH);
		XSetForeground(game.dsp, game.gc, game.col.white);
		XCopyPlane(game.dsp, loseSC, Buffy, game.gc, 0, 0, sw, sh, (game.scrW-sw)/2, (game.scrH-sh)/2, 1);
	}else{
		if(resetTime > 0){
			resetTime--;
		}else{
			face = 0;
		}

		if(ship->H < ship->maxH && !ship->dead){
			ship->H++;
			if(play.homunculus){
				ship->H+=4;
			}
		}

		if(ship->P < ship->maxP && !ship->dead){
			ship->P+=2;
			if(play.over9000){
				ship->P+=2;
			}
		}

		physics();

		XSetForeground(game.dsp, game.gc, game.col.black);
		XFillRectangle(game.dsp, Buffy, game.gc, 0, 0, game.scrW, game.scrH);

		handleRenderStars();

		camera();

		//draw reactor stability
		int r = (ship->H*(g_pulse-1))/ship->maxH;
		XSetForeground(game.dsp, game.gc, game.col.gradReactor[r]);
		XDrawLine(game.dsp, Buffy, game.gc, 10, 10, 210, 10);
		for(int i=10; i<(ship->H/5)+10; i+=2){
			XDrawLine(game.dsp, Buffy, game.gc, i, 10, i, 15 + (500/i));
		}

		//draw reactor power
		r = (ship->P*(g_pulse-1))/ship->maxP;
		XSetForeground(game.dsp, game.gc, game.col.gradPulse[r]);
		for(int i=10; i<(ship->P/5)+10; i+=2){
			XDrawLine(game.dsp, Buffy, game.gc, i, 15 + (500/i) + 2, i, 20 + (1000/i));
		}

		//draw pilot face
		XSetForeground(game.dsp, game.gc, game.col.gray192);
		if(!ship->dead){
			switch(face){
			case 0:
				XCopyPlane(game.dsp, fineFace, Buffy, game.gc, 0, 0, bw, bh, game.scrW-10-bw, game.scrH-10-bh, 1);
				break;
			case 1:
				XCopyPlane(game.dsp, hurtFace, Buffy, game.gc, 0, 0, bw, bh, game.scrW-10-bw, game.scrH-10-bh, 1);
				break;
			}
		}
		handleGameMessages();
		renderScore();

		deathTimer();
	}
}

//New game GLHF
//start new game, un-win, un-kill, reset timers, reset positions, reset score, re-init stuff, reset message positions
void reset(){
	//reset game and ship
	game.screen = 2;
	play.win = false;
	deathCD = 150;
	ship->x = shipInitX;
	ship->y = 0;
	ship->vx = 0;
	ship->vy = 0;
	ship->H = ship->maxH;
	ship->P = ship->maxP;
	ship->dead = false;
	ship->exploded = false;

	//reset camera
	sccX = shipInitX;
	sccY = 0;
	sccVX = 0;
	sccVY = 0;

	//clear data
	warps.clear();
	aliens.clear();

	//re-init
	initTerrain();
	initStars();
	activeParts.clear();
	bufferParts.clear();
	activeLaser.clear();
	buffer.clear();
}

void handleKeyPress(XEvent e){
	switch(getKS(e)){
	case XK_Left:
	case XK_a:
		k.left = true;
		break;
	case XK_Right:
	case XK_d:
		k.right = true;
		break;
	case XK_Up:
	case XK_w:
		k.up = true;
		break;
	case XK_Down:
	case XK_s:
		k.down = true;
		break;
	case XK_space:
		if(game.screen == 2 && !play.win){
			paused = !paused;
		}else{
			reset();
		}
		break;
	}
}

void handleKeyRelease(XEvent e){
	switch(getKS(e)){
	case XK_Left:
	case XK_a:
		k.left = false;
		break;
	case XK_Right:
	case XK_d:
		k.right = false;
		break;
	case XK_Up:
	case XK_w:
		k.up = false;
		break;
	case XK_Down:
	case XK_s:
		k.down = false;
		break;
	case XK_q:
		loop = false;
		break;
	case XK_Delete:
		play.keikaku_doori = !play.keikaku_doori;
		for(int i=0; i<aliens.size(); i++){
			explodA(aliens[i].x, aliens[i].y);
		}
		aliens.clear();
		break;
	case XK_k:
		ship->kill();
		break;
	case XK_h:
		play.hardcore = !play.hardcore; //toggle hardcore mode
		break;
	case XK_i:
		play.homunculus = !play.homunculus; //toggle heal using philosopher's stones
		break;
	case XK_p:
		play.over9000 = !play.over9000; //toggle what does the scouter say about his power level
		break;
	case XK_m:
		play.malphite = !play.malphite; //toggle I'm an immovable object
		break;
	case XK_f:
		play.fraps = !play.fraps; //toggle fps tracker
		break;
	}
}

void handleModify(XEvent e){
	if((e.xconfigure.height != game.scrH)||(e.xconfigure.width != game.scrW)){
		game.scrH = e.xconfigure.height;
		game.scrW = e.xconfigure.width;
		XFreePixmap(game.dsp, Buffy);
		Buffy = XCreatePixmap(game.dsp, game.win, game.scrW, game.scrH, DefaultDepth(game.dsp, DefaultScreen(game.dsp)));
		initStars();
	}
}

void handleMouseMove(XEvent e){
	mouseX = e.xmotion.x;
	mouseY = e.xmotion.y;
}

void handleMousePress(){
	mouseDown = true;
}

void handleMouseRelease(){
	mouseDown = false;
}

void handleEv(XEvent e){
	switch(e.type){
	case ConfigureNotify:
		handleModify(e);
		break;
	case ButtonPress:
		handleMousePress();
		break;
	case ButtonRelease:
		handleMouseRelease();
		break;
	case MotionNotify:
		handleMouseMove(e);
		break;
	case KeymapNotify:
		XRefreshKeyboardMapping(&e.xmapping);
		break;
	case KeyPress:
		handleKeyPress(e);
		break;
	case KeyRelease:
		handleKeyRelease(e);
		break;
	}
}
